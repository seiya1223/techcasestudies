---
layout: post
title:  "EDP | Home Smartmeters"
author: "João Almeida"
author-link: "http://github.com/joalmeid"
#author-image: "{{ site.baseurl }}/images/edp/edp01.png"
date:   2017-01-05
categories: IoT
color: "blue"
#image: "{{ site.baseurl }}/images/edp/edp02.png" #should be ~350px tall
excerpt: Nos últimos anos, a EDP desenvolveu a solução Re:dy. Trata-se de um produto de gama alta, na classe de Domótica, que pode ser associado a uma assinatura de cliente. Re:dy é um produto poderoso, mas não é fácil de instalar e acaba por ser um serviço oneroso para o cliente final. A EDP procura soluções mais acessíveis baseado num produto mais fácil de instalar na casa de clientes. Idealmente esta nova versão do produto deve ser instalada pelo próprio cliente sem a necessidade de deslocação um técnico.
language: Portuguese
verticals: [Energy, Smart Cities]
---
    

![Logotipo EDP]({{ site.baseurl }}/images/edp/edp02.png "Logotipo EDP")

A EDP é uma empresa de serviços integrados verticalmente, é a maior geradora, distribuidora e fornecedora de electricidade em Portugal e tem operações significativas em electricidade e gás em Espanha. A EDP é a terceira maior empresa de produção de electricidade e uma das maiores distribuidoras de gás da Península Ibérica.

A EDP tem presença relevante no panorama energético mundial, estando presente em 14 países, com mais de 10 milhões de clientes de eletricidade e 1,4 milhão de pontos de fornecimento de gás e mais de 12 mil funcionários em todo o mundo. A 31 de dezembro de 2015, a EDP tinha uma capacidade instalada de 24,4GW, gerando 63,7TWh, sendo 72% provenientes de usinas eólicas e hídricas.
 
Em 2015, seguindo o desempenho nas dimensões económica, social e ambiental, a EDP integrou índices de sustentabilidade (DJSI World e Europa).

Vivemos na era da inovação no setor de energia. A energia renovável tem vindo a crescer significativamente na última década e a EDP tem sido um líder desta revolução da energia limpa. A integração das tecnologias de informação e comunicação com a rede de distribuição secular tem sido a chave para permitir a crescente penetração de energia renovável e maximizar o potencial de eficiência energética. A geração solar nos agregados familiares, combinada crescentemente com o armazenamento estático, e a gerência integrada das cargas de dispositivos elétricos é o futuro do retalho energético. Os carros elétricos estão em crescimento exponencial e serão a referência na mobilidade, moldando a relação entre clientes de energia e recursos. Um novo mundo energético emerge, onde o conforto do serviço, a mobilidade, a sustentabilidade e a economia serão impulsionados por uma abordagem *multitech* apoiada em IoT emergente, *machine learning* e tecnologias *Big Data*. A EDP é forte crente na inovação aberta. A EDP trabalha com universidades, instituições científicas, startups, fornecedores da cadeias de valor e muitas outras fontes de inovação. A EDP colabora com empresários, grandes *business angels* corporativos, fundos de capital de risco e outros investidores. Eles disponibilizam um conjunto de ferramentas que incluem financiamento, suporte de gestão e uma base de teste orientada a negócios com presença internacional. A EDP está empenhada em estar na vanguarda da inovação energética.

### EDP Starter ###

<img src="{{ site.baseurl }}/images/edp/edp33.png" width="500">

EDP Starter é o ecossistema de empreendedorismo da EDP. Corresponde ao programa para apoiar projetos na indústria de energia, do estágio da idéia ao investimento de capital de risco.

Um conceito de incubação inovador para startups no setor de energia. Muito mais do que um espaço físico, a EDP Starter é um potenciador de rede de contactos, dentro e fora do Grupo EDP, e um disseminador de conhecimento, permitindo que as empresas iniciantes se preparem melhor para o crescimento nos mercados doméstico e internacional. A rede de parceiros é um catalisador para o sucesso, orientando as startups ao longo das diferentes etapas da sua jornada. Portanto, a EDP Starter já avaliou 500 projetos, ajudaram 25 startups e criaram 250 empregos.

### Narrow Net ###

![Logotipo Narrow Net]({{ site.baseurl }}/images/edp/edp31.png "Logotipo Narrow Net")

Portugal foi sempre um País pioneiro nos Descobrimentos, geográficos e tecnológicos. É bem sabido que "demos novos mundos ao Mundo" e, nos exemplos tecnológicos, podemos realçar, como exemplo, o pioneirismo, e rápida adoção pelos Portugueses, nos casos da Via Verde©, massificação das caixas Multibanco© ou penetração de telemóveis.

Todas estas descobertas e adoções foram orientadas no sentido de melhorar a qualidade de vida das pessoas.

A NarrowNet, seguindo esta filosofia, definiu a sua Missão como empresa, ou seja, que mais uma vez, Portugal lidere um dos desafios mais atraentes do Sec. XXI: permitir que os objetos falem entre si, para melhorar a qualidade de vida das pessoas, com custos insignificantes.

Para isso põe à disposição de todos a tecnologia de comunicação Ultra Narrow Band (UNB), exclusivamente desenhada para a Internet das Coisas, e com grandes possibilidades de poder vir a converter-se num standard da comunicação entre os objetos no futuro.

Mas, acima de tudo, esta tecnologia, com custos insignificantes, permite o acesso a toda a população de serviços até agora inacessíveis a todos, convertendo-o num grande benefício social.

A Narrow Net S.A., é uma empresa portuguesa que detém os direitos exclusivos da aplicação desta tecnologia (patenteada pela SIGFOX) para Portugal, com o intuito de desenvolver uma rede de comunicação especifica no nosso país, e simultaneamente desenvolver o ecossistema.

## Ecossistema de Startups ##

Apesar da sua história relativamente recente, foram identificados em Portugal 40 *scaleups* (startups com financiamento de mais de > $1M desde a fundação e pelo menos uma ronda de investimento nos últimos 5 anos). Foram acumuladas mais de $166M de capital de risco desde o início, com uma média de $4,2M cada. 24 outras empresas foram capazes de garantir financiamento na faixa de $0,5-$1M.

Hoje, o ecossistema de Startups está numa posição muito diferente da que era há alguns anos. Após a loucura inicial, startups, empresários e os diferentes intervenientes tornaram-se mais maduros. Agora, startups como Uniplaces, Feedzai, Unbabel, Talkdesk, Veniam e Seedrs estão liderando o caminho. Empresários como Miguel Amaro, Cristina Fonseca, Nuno Sebastião, João Barros, Vasco Pedro e Carlos Silva lideram a comunidade e inspiram uma nova geração de empresários a construir empresas com mentalidade internacional. Hoje, empresas internacionais de VC, como Index Ventures, Balderton ou Accel Partners olham para Portugal como uma boa fonte de startups com verdadeiro potencial.

Portugal está a crescer a partir da crise financeira dos finais de 2000 e emergir rapidamente no mapa de startups europeu, com uma comunidade empresarial muito vibrante capaz de produzir resultados tangíveis, apesar da sua história relativamente jovem. Embora ainda não possa ser comparado com os principais países como o Reino Unido, a Alemanha ou França, Portugal partilha muitas das mesmas semelhanças - e uma diferença menor - com a Espanha e, em particular, com a Itália.

## Domótica e medidores inteligentes ##

Os sistemas de medição inteligente medem o consumo de eletricidade e são implementados para substituir os métodos manuais de coleta de informações sobre o uso de energia. Ao permitir acompanhar o consumo, os medidores inteligentes são uma ferramenta útil para entender onde o uso de energia pode ser cortado e onde é necessário implementar medidas de optimização de consumo. Da mesma forma, pode-se comunicar com os sistemas de automação residencial para ajudar a controlar o uso de energia, particularmente nos momentos em que os custos estão no auge.

## O desafio ##

A EDP iniciou à bastantes anos, a integração de tecnologias de informação e comunicação com a rede de distribuição. Actualmente fornece aos seus clientes residenciais medidores inteligentes, munidos de tecnologia que pode ser explorado de formas inovadoras.

A EDP **decidiu desafiar as startups** a encontrarem uma solução pouco onerosa para o cliente final, fácil de instalar e utilizar. Esta solução deve permitir um cliente final recolher dados sobre o consumo energético e explorar formas de utilizar a informação recolhida. Visa-se explorar novos modelos de negócio que podem incluir abordagens *open source* até produtos comercializáveis. A integração coma indústria de domótica é também incluída.

A melhor abordagem para um desafio desta natureza seria através de um hackathon.

### Hackathon Público ###

A preparação de um hackthon público, desta natureza, requer no entanto, um trabalho que envolve competencias técnicas de hardware e software. A EDP cedo optou por dimensionar o hackathon para um máximo de 20 equipas de 3 elementos. As candidaturas dos participantes será avaliado pela Microsoft e EDP.

Esse foi o desafio, cuja solução detalha-se em baixo.

## Solução ##

Cedo entendeu-se que o desafio principal seria o desenvolvimento de hardware que permitisse a equipas com menos skills em Hardware competir de forma justa. Desejava-se que equipas fortes no desenvolvimento de software tivessem a oportunidade de aplicar os seus conhecimentos, sem ter obrigatoriamente de desenvolver o hardware. Do mesmo modo, não era desejável que equipas com experiencia em hardware - os makers - não fossem recompensados apropriadamente.

Deliverables

1.	Algoritmo de compressão SIGFOX – Comprime mensagem de 16b para um volume menor que 12b.
2.	SIGFOX Callback, IoT Hub, Azure Stream Analytics, Power BI, Logic Apps, Notification Hub Setup – Para processar mensagens SIGFOX, processar, visualizar e notificar.
3.	EDP IoT Box - Shield de Arduino customizado, Caixa customizada impressa em 3D
4.	edpComm Library – Biblioteca C++ para a comunicação da EDP IoT Box
5.	Azure Ramp Up Material – Documentação, tutoriais e exemplos de código;
6.	Arduino Ramp Up Material – Documentação, tutoriais e exemplos de código;
7.	EDP Hackathon Website - Pode visitar o site em [*http://edpiothackathon.edp.pt*](http://edpiothackathon.edp.pt). 

![EDP IoT Hackathon Logo]({{ site.baseurl }}/images/edp/edp32.png "EDP IoT Hackathon Logo")


Autores:

- João Almeida – Senior Technical Evangelist, Microsoft Portugal
- Luis Calado – Principal Technical Evangelist, Microsoft Portugal
- Jon Gallant – Principal Software Developer, Microsoft Corp.
- Francisco Maria Santos – Software Developer, EDP  
- Diogo Ribeiro – Electrical Engineer, EDP
- João Sabido – Entrepreneurship & Business Incubation, EDP Starter

![Quadro de trabalho da equipa e Francisco Santos]({{ site.baseurl }}/images/edp/edp18.jpg)


## Preparação do Hackathon ##

Um dos grandes objectivos ficou definido como a criação adequada de documentação para o Hackathon publico. Foi classificada a possível audiencia do Hackathon e como resultado foram identificadas três *personas* distintas: **Iniciante**, **Intermédio** e **Avançado**. O objectivo seria criar documentação apropriada a a cada *persona*.

- Iniciante: Haverão equipas com menos experiencia nas componentes de Hardware e/ou software. Poderão ser startups dedicadas ao desenvolvimento de hardware e que terão mais facilidade em deduzir como extrair dados do leitor inteligente da EDP (EDP Box); De igual forma, os candidatos poderão ter fortes skills apenas no desenvolvimento de software, nomeadamente nas áreas de visualização de dados ou mesmo Cloud. 

- Intermédio: As equipas candidatas também terão elementos com conhecimento intermédios nas áreas de Hardware e/ou Software. O objetivo será de providenciar documentação adequada aos conhecimentos para que sejam o mais produtivos possívels. A aprendizagem é um objectivo claro e devem ser criadas as condições ideais para tal acontecer. Desta forma os resultados serão mais valiosos. Para este tipo de candidatos, pretende-se que facilmente apliquem os seus conhecimentos, evoluam e sejam bem sucedidos a criar valor acrescentado.

- Avançado: É objetivo da EDP ter aplicações de startups com experiencia comprovada nas áreas de Hardware e/ou Software. Para que o hackathon lhes seja uma experiencia valiosa, será necessário ter desafios e documentação adequada. Estes candidatos quererão por em pratica os seus conhecimentos e investigar abordagens inovadoras enquadrado no desafio colocado. Deseja-se que estes candidatos tenham a orientação certa para surpreender os jurados.

Foi decidido disponibilizar documentação apropriada a cada uma das personas, segmentando a documentação por Software e Hardware. 

Do ponto de vista técnico, o desafio seria permitir uma experiencia de desenvolvimento de Hardware, aos candidatos, que não fosse excessivamente exigente. Tendo em conta que poderão haver participantes com poucos conhecimentos de Hardware, seria importante poder dar uma solução testada e garantida - Seria desejável que estas startups possam querer investir mais na área de softwre onde têm skills. 

O maior desafio técnico na elaboração da EDP IoT Box, foi a integração com SIGFOX. A comunicação [*SIGFOX*](https://en.wikipedia.org/wiki/Sigfox), como protocolo wireless de baixo consumo energético, define um limite de 12 Bytes para o tamanho das mensagens e um máximo de 140 mensagens na Europa (ETSI 300-220). 

A informação que se pretende retirar da EDP Box, no entanto, tem uma dimensão maior, logo seria necessário definir uma estrutura de dados acomodadas às necessidades e/ou apostar num mecanismo de compressão.

### Arquitectura Técnica ###

A arquitectura técnica foi definida previamente após um trabalho de pesquisa feito pelas equipas de engenharia da EDP. Um dos pontos relevantes seria a comunicação via SIGFOX que envolveu a colaboração da empresa [*Narrow Net*](http://narrownet.pt/), responsável pela disponibilização de SIGFOX em Portugal.

Esta arquitectura corresponderá á proposta da organização, do hackathon, para o hardware. Desta forma as equipas com mais dificuldades em desenvolver o hardware, conseguirão seguir as indicações com base nos diagramas e instruções que serão disponibilizadas.

Neste projecto, o maior objetivo seria definir, testar e documentar esta composição, a que foi dado o nome de EDP IoT Box:

![Akery 3.3 beta]({{ site.baseurl }}/images/edp/edp03.jpg)


![EDP Box - Smart Meter]({{ site.baseurl }}/images/edp/edp08.png)


| Component                  | Provider        | Details                                                                     | Description  |
|----------------------------|-----------------|----------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Placa de desenvolvimento IoT | SnootLab | [*Akeru beta 3.3*](http://snootlab.com/lang-en/snootlab-shields/829-akeru-beta-33-en.html)    | Esta nova versão do Akeru oferece um melhor acesso às funcionalidades avançadas do modem com um baixo consumo de energia. Permite prototipagem rápida com as tecnologias SIGFOX e Arduino/Genuino. Com aplicação no desenvolvimento de dispositivos para leitura de medidore da água/eletricidade, contagens de execução ou aviso da poluição. A comunicação via tecnologia IoT SIGFOX é feita mediante o envio de dados para uma porta serie através do Arduino. |
| EDP Box            | EDP (Janz C380 Prime) | [*Energy Counter*](http://www.janzce.pt/files/Cat__logo_C380_PRIME_PT.pdf)    | Monofásico, gama de corrente10-80A, tensão de referência 220/230V, energia activa e reactiva, soluções AMM e para Smart Grids, 32 tarifas (capaz de operar em 2 tarifas em simultâneo). Capacidade de Comunicação GSM, GPRS, PSTN, Ethernet e PLC. |

A EDP IoT Box sofreu várias interações até ao formato final. Foram utilizados vários componentes:

![Diagram EDP IoT Box]({{ site.baseurl }}/images/edp/edp12.png)


![Fase de prototiapagem da EDP IoT Box]({{ site.baseurl }}/images/edp/edp15.jpg)


![Circuito integrado]({{ site.baseurl }}/images/edp/edp09.jpg)


| Phase                  | Component        | Details                                                                     | Description  |
|----------------------------|-----------------|----------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Prototipagem | Bread board | [*ABS Prototyping Board*](http://www.newark.com/multicomp/mcbb830/breadboard-solderless-abs/dp/99W1760) | Foi utilizada um bread board na fase de prototipagem para testar a conectividade entre a EDP Box (porta Han) e a placa da Akeru. Placas semelhantes a este encontram-se em qualquer fornecedor de electrónica. |
| Prototipagem | Fritzing (software) | [*Fritzing*](http://fritzing.org) | Fritzing é uma aplicação open source que torna a eletrónica acessível. Ferramenta de software que permite definir diagramas de eletrónica e fortemente suportado pela comunidade. Promove um ecossistema criativo que permite aos utilizadores documentar seus protótipos, compartilhá-los, ensinar eletrónica e fabricar PCBs profissionais. |
| Prototipagem | MAX485CPA+ IC | [*MAX485CPA+*](http://www.newark.com/maxim-integrated-products/max485cpa/ic-cmos-bus-transceiver-dip8-485/dp/92K6596) | O MAX485 é transceptor de baixa potência para comunicação RS-485. Cada parte contém um driver e um receptor. Possui drivers de taxa reduzida reduzindo o EMI e reflexos causados por cabos mal terminados, permitindo transmissão de dados sem erros até 250kbps.|
| Caixa exterior | Placa de prototipagem | [*54T9823*](http://www.newark.com/twin-industries/8000-45-lf/pcb-prototype-board-fr4/dp/54T9823) | A placa de prototipage (PCB) foi utiliza para criar um circuito integrado (IC) como uma peça única. A [*placa utilizada*](https://mauser.pt/catalog/product_info.php?cPath=324_708_1565&products_id=59881) foi comprada localmente. A grande preocupação seria a de criar um circuito integrado que tivesse dimensões menores que a placa Akeru, de forma a caber dentro de uma caixa exterior única. |
| Caixa exterior | Caixa impressa em 3D | [*Fusion 360 Model*](http://a360.co/2dLYUIe) | Uma vez terminado circuito integrado, em conjunto com a placa Akeru, foi possível desenhar um modelo 3D para a caixa exterior, acrescentando o logotipo da EDP. Ficava terminada a EDP IoT Box. Foi utilizado o [*Fusion 360*](http://www.autodesk.com/products/fusion-360/students-teachers-educators), da Autodesk, para a criação do modelo 3D. A impressão ficou a cargo da equipa da [*EDP Labelec*](http://edplabelec.com/en/) e foi feita no [*FabLab*](http://edplabelec.com/en/#fablab). |

![Edp IoT Box com caixa impressa em 3D]({{ site.baseurl }}/images/edp/edp10.jpg)


![EDP Box e EDP IoT Box com caixa impressa em 3D]({{ site.baseurl }}/images/edp/edp13.jpg)


#### A placa Akeru ####

A placa AKeru manipula-se como um Arduino, podendo inclusivé utilizar as ferramentas de desenvolvimento de [*Arduino*](https://www.arduino.cc).

O desenvolvimento no Akeru é igualmente feito na linguagem de Arduino, que é um sub conjunto de C/C++, com algumas funções especificas para o hardware. São gerados *sketchs* e passado directamente para um compilador de C/C++ (avr-g++). 

Este desenvolvimento consistiu na implementação do protocolo [*Modbus*](https://en.wikipedia.org/wiki/Modbus), utilizado para comunicar através da porta HAN na EDP Box. Recorreu-se ao projeto open source [*Modbus-Master-Slave-for-Arduino*](https://github.com/smarmengol/Modbus-Master-Slave-for-Arduino) para garantir a comunicação ModBus.

Para implementar a comunicação de SIFOX, a SnootLab disponibiliza uma [*Biblioteca Akeru*](https://github.com/Snootlab/Akeru), onde são disponibilizados funções para inicialização da comunicação e envio de dados.

O principal desafio, foi o algoritmo de compressão de dados para envio via SIGFOX. Com base na informação recolhida via Modbus da EDPBox, foram identificados os dados relevantes e analisados:


|   | Ano   | Mês   | Dia| *Offset*    |  *Clock Status*   | *AMR Profile Status*     | *Payload*
-----|---|-------|-------|----------|-----------|----------|----------------------|
| Exemplo   | 16 | 09   | 26   | xx | xx   |xx | xx
| Dimensão  | 1B    | 1B | 1B  | 1B |	1B | 1B | 4B


**Notes:**

1.	Assumindo uma implementação até ao ano 2099. Permite apenas ano com dois caracteres.(1Byte);
2.	*Offset* deve ser considerado como a contagem de intervalos de 15 minutos desde as 00h00.
3.	Um total de 96 intervalos por dia.

Com este algoritmo foi possível baixar a dimensão das mensagens a um valor inferior a 12 Bytes - o limite em SIGFOX.

Seguem alguns *snippets* de código que fazem parte da biblioteca EDPcomm, que reuniu toda esta implementação:

```cpp
// Initialize Libs
Akeru akeru(RX, TX);
Modbus master(0); //0 for master and [1,247] for slave
modbus_t telegram; //structure for query slave
SoftwareSerial mySerial(10, 11); //Create a SoftwareSerial on pins 10&11
EDPComm edpComm(&mySerial, &akeru); //start EDPComm lib
```

O envio de dados através de SIGFOX, foi trivial, utilizado a biblioteca fornecida pela SnootLab:

```cpp
void EDPComm::sendToSigfox(const String payload)
{
	bool send = akeru->sendPayload(payload);
	if(send)
	{
		Serial.println("Message sent to Sigfox.");
	}
	else
	{
		Serial.println("Message could not be sent to Sigfox.");
	}
    resetSerial(BAUD_RATE);
}
```

Fazer a leitura de dados da EDP Box, exigia ler as estruturas de dados de acordo com a implementação Modbus e as especificidades da EDP Box: 

```cpp
int EDPComm::getLoadProfileData(uint16_t dataArray[16]){
	/*this function returns the last load profile data considering the default load profile structure with a variable size of 4 bytes
	*/
	 int profileValue_1half= (((dataArray[6]<<8)&0xFF00) | ((dataArray[7]>>8)&0xFF))*0x10000; 
     int profileValue_2half= ((dataArray[7]<<8)&0xFF00) | ((dataArray[8]>>8)&0xFF);
	 int totalValue = profileValue_1half+profileValue_2half;
	 
	return totalValue;         
}
```

### Arquitectura da plataforma cloud ###

Para permitir o envio das leituras da EDP Box para uma plataforma cloud, como o [*Microsoft Azure*](https://azure.microsoft.com/), seria necessário definir um arquitectura para o backend cloud. Os principais objetivos identificados foram:

- Integrar as mensagens enviadas via SIGFOX para a plataforma Microsoft Azure;
- Persistir os dados recebidos na plataforma cloud e garantir a sua veracidade. Os dados persistidos deveriam ter a capacidade de serem processados e reutilizados para diferentes tipos de análise. Idealmente deveria ser possível utilizar qualquer solução de dados para processar os dados;
- Implementar uma arquitectura que permitisse visualizar as leituras em *near-real time*, utilizado os serviços de Microsoft Azure; 
- Testar e investigar cenários de detecção de anomalias na leitura.

![Cloud Arquitecture]({{ site.baseurl }}/images/edp/edp05.jpg)


Para tal foi seguida uma implementação de acordo com a [*Azure IoT Reference Architecture*](http://download.microsoft.com/download/A/4/D/A4DAD253-BC21-41D3-B9D9-87D2AE6F0719/Microsoft_Azure_IoT_Reference_Architecture.pdf). A ingestão de dados, foi o principal ponto na qual foi identificado o [*Azure IoT Hub*](https://azure.microsoft.com/en-us/services/iot-hub/), como peça fundamental. No entanto iniciámos pelo protocolo de comunicação: 

#### SIGFOX ####

[*SIGFOX*](www.sigfox.com) é uma empresa francesa que constrói redes sem fio para conectar objetos de baixa energia, como medidores de energia elétrica, *smartwatches* e máquinas de lavar, que precisam estar continuamente ligados e emitindo pequenas quantidades de dados. SIGFOX foi fundada em 2009 fornecendo conectividade celular global para cenários de *Internet of Things* (IoT). Sua infra-estrutura é independente das redes existentes, como as redes de telecomunicações.

A SIGFOX implementa as chamadas *Low-Power Wide Area Networks* (LPWAN) que integram com hardware que os fabricantes podem adicionar aos seus produtos. Em termos de compatibilidade, a rede adopta uma abordagem semelhante às redes GSM tradicionais. Qualquer dispositivo com hardware SIGFOX integrado poderá ter conectividade à Internet - em regiões com cobertura da rede SIGFOX - sem qualquer hardware externo, como um *router* Wi-Fi ou Zigbee. Todavia, a rede SIGFOX é totalmente diferente das redes GSM tradicionais, na medida em que só pode transmitir pequenas quantidades de dados.

O principal factor que levou à opção de SIGFOX, está relacionado com o baixo consumo energético e a fiabilidade da comunicação. Em seguida deixamos um resumo da tecnologia:

| SIGFOX Radio Technology ||
|----------------------------|-----------------|
| Purpose | Specially conceived for M2M/IoT.|
| Identity | Each device has a unique ID (NOT an IP); |
| Ultra Narrow Band | - Energy-efficient; - Resistant to jamming; |
| Spectrum | ISM free-to-use (ETSI 300-220); Forces 1% duty cycle; Base stations MUST comply as well;
| Frequency | 828 MHz (Europe); 902 MHz (USA); |
| Long Range & Protocols | 2-way communication with 162 dB path loss; |
| Customer Payload | 12 byte messages with a MAXIMUM of 140 message per day in Europe (ETSI 300-220).|

Neste projeto seria necessário fazer chegar as mensagens com as leituras de consumo da da EDP BOX à plataforma cloud. A SIGFOX disponibiliza formas de integrar com sistemas aplicacionais - foram utilizadas as *custom callbacks*. O SIGFOX permite recuperar as mensagens enviadas a partir dos dispositivos através de *callbacks*. É possível configurar *callbacks* para que em eventos específicos, as mensagens sejam enviadas para um nosso serviço/aplicação/servidor. Por exemplo, o dispositivo pode enviar uma mensagem SIGFOX, a partir de extimulo especifico; Poderá ser notioficado quando esse evento ocorreu. A SIGFOX permite pre-configurar a retransmissão das mensagens para os principais fornecedores cloud, entre os quais Microsoft Azure.

![Creating a new SIGFOX custom callback]({{ site.baseurl }}/images/edp/edp23.png)


Estando o dispositivo (capacitado de SIGFOX) registado e capaz de enviar mensagens, seremos capazes de criar uma *custom callback* a partir da [*página de serviço da SIGFOX*](http://backend.sigfox.com). No caso da EDP, a configuração foi bastante simples, uma vez que apenas foi necessário configurar os seguintes items:

- Configuração do formato da mensagem: Este campo permite especificar como você gostaria que o SIGFOX decodificasse a carga útil de seu dispositivo. Você pode, por exemplo, desejar descodificar um byte de entrada como um inteiro sem sinal. A configuração neste caso foi:

```
year::uint:16:little-endian month::uint:16:little-endian day::uint:16:little-endian offset::uint:16:little-endian amr::uint:16:little-endian payload::uint:16:little-endian
```

- A configuração de acesso ao Azure IoT Hub (ver em baixo). Em vaixo é possivel avaliar a estrutura da *connection string* que identifica qual a instância de IoT HUb, fornecendo também as respectivas configurações de segurança.

```
HostName=xxx.azure-devices.net;SharedAccessKeyName=xxxx;SharedAccessKey=xxxxxxxxxxxxxxxxxxxxxxxxxx
```

- Definir a estrutura da mensagem num formato JSON: Este é o conteúdo principal da sua mensagem. É possível especificar qualquer formato, desde que dentro do limite máximo. É ainda possível recorrer a variáveis disponiveis para qualquer mensagem. Neste caso o formato da mensagem teve a seguinte estrutura: 

```json
{
"deviceId" : "{device}",
"year" : "{customData#year}",
"month" : "{customData#month}",
"day" : "{customData#day}",
"offset" : "{customData#offset}",
"amr" : "{customData#amr}",
"payload" : "{customData#payload}"
} 
```

![SIGFOX custom callback]({{ site.baseurl }}/images/edp/edp22.png)


Desta forma conseguimos integrar os dispositivo através de comunicação SIGFOX com a plataforma de *backend* cloud base utilizando o Windows Azure. O seviço de Azure que utilizamos para receber todas as mensagens é o IoT Hub que descrecemos em seguida:

#### IoT hub ####

A implementação do cloud backend tem como peça principal o Azure IoT Hub, um serviço cloud que permite o *upload* de dados de forma segura e capacitado de receber elevados volumes de dados.  Na implementação do *backend* da EDP, seria interessante garantir que os dados pudessem ser persistidos e processados com multiplos propósitos. 

Neste caso em particular, apesar de estar a utilizar um dispositivo baseado em Arduino (Akeru), não foi necessário recorrer a um dos [*Azure IOT SDK*](https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-sdks) disponiveis para comunicar com o IoT Hub. Esta comunicação é garantida através das *custom callbacks* da plataforma SIGFOX. 

Um dos pontos analisados, foi a possibilidade de tratar os dados de input de IoT Hub. O cenário foi idealizado, tendo em conta a necessidade de compressão das mensagens. Actualmente o IoT Hub não fornece capacidade de processar as mensagens chegadas, ou seja descomprimir mensagens. No entanto foi um cenário que chegou à equipa de produto e será analisada.

#### Stream Analytics ####

Foi utilizado o [*Azure Stream Analytics*](https://azure.microsoft.com/en-us/services/stream-analytics/) integrado com o IoT Hub, para processar os dados em *real time*, de acordo com as várias necessidades de processamento. Na realidade o Stream Analytics corresponde a um serviço que disponibiliza um sistema [*complex event processing (CEP)*](https://en.wikipedia.org/wiki/Complex_event_processing).

![Configuração para Azure Stream Analytics]({{ site.baseurl }}/images/edp/edp27.png)


- Foi definida uma query, que enviará os dados para o PowerBI (ver em baixo), efectuando algumas transformações dados. O motivo prende-se com o algoritmo de compressão que foi criado dadas as limitações de SIGFOX. Desta forma conseguimos recuperar a totalidade dos dados. O Stream Analytics é na realidade responsável pela descompressão dos dados, provenientes das EDP Box.

- Simultaneamente, outra query define como output o [*Service Bus*](https://azure.microsoft.com/en-us/services/service-bus/). Este cenário inicia implementação de deteção de anomalias no consumo energético.

#### Visualização de dados com Power BI ####

Com o objectivo de demonstrar a visualização de dados em *near real time*, uma das opções imediatas foi o Power BI. Corresponde a um conjunto de ferramentas de análise de dados e uma forte componente visual. Encontra-se munido com painéis de controle avançados e é multi plataforma, significando que pode ser consumido através da Web ou qualquer dispositivo móvel. A criação de um painel de controle é bastante simples, pois o acesso aos dados é bastante ágil. É possível combinar bases de dados, dados de *web services* ou mesmo modelos de *Analysis Services*.~

Estando a receber as mensagens via SIGFOX, temos disponivel no Stream Analytics (ASA) a integração directa com Power BI. É possível definir o PowerBI como output do ASA. Nota para a necessidade de autorizar o Stream Analytics para aceder à subscrição de Power BI.
Um vez enviados dados, e processados pelo ASA, estes são disponibilizados no Power BI através de um *dataset*. A partir deste ponto será possível criar relatórios e *dashboards*. Com a EDP foi customizado uma página que apresenta dados provenientes de um despositivo real e um emulador.

![Visualização de dados com o Power BI]({{ site.baseurl }}/images/edp/edp07.jpg)


Para mais informação consultar um excelente tutorial disponivel no artigo [*A real-time analytics dashboard for streaming data*](https://docs.microsoft.com/en-us/azure/stream-analytics/stream-analytics-power-bi-dashboard).

#### Anomalias no consumo energético ####

O objetivo seria simular a detecção de anomalias no consumo energético, recolhido a partir da EDP Box. Depois de configuração do Stream Analytics, serão enviadas mensagens acima de um determinado valor. Este fluxo de dados é iniciado apenas para mensagens que indiquem valores acima do predefinido. As mensagens são enviadas para [*Service Bus Topics*](https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-queues-topics-subscriptions) permitindo a comunicação de um para muitos seguindo um padrão de *publish/subscribe*. Visto que num cenário real, seriam envolvidos multiplos utilizadores, a utilização de *Topics* seria a mais adequada. Cada mensagem publicada é disponibilizada para cada assinatura registrada com o tópico. As mensagens são enviadas para um tópico e são entregues a uma ou mais assinaturas associadas. As mensagens não são recebidas diretamente do tópico. Em vez disso, eles são recebidos nas assinaturas. Uma assinatura de tópico é semelhante a uma fila virtual que recebe cópias das mensagens que são enviadas para o tópico. As mensagens são recebidas de uma assinatura de forma idêntica à forma como são recebidas de uma fila. 

Neste cenário, foi criada um tópico chamado enery tal como é demonstrado na figura seguinte.

![Configuração da Service Bus]({{ site.baseurl }}/images/edp/edp29.png)


O consumidor das mensagens neste tópico foram asseguradas pelo serviço de [*Logic Apps*](https://docs.microsoft.com/en-us/azure/app-service-logic/app-service-logic-what-are-logic-apps). Este serviço fornece uma maneira simples de implementar integrações de forma escalável. Fornece um *designer* visual para modelar e automatizar qualquer processo como uma série de etapas conhecidas como um fluxo. Existe uma panóplica de conectores que garantem a integração com outros serviços e protocolos. No cenário de detecção de anomalias a **Logic App** é responsável por detectar mensagens no Service Bus Topic e reenvia-la para um **Notification Hub**. 

![Configuração da Logic App]({{ site.baseurl }}/images/edp/edp28.png)


O objectivo final seria notificar os utilizadores através de uma aplicação móvel, pelo que a utilização da [*Notification Hub*](https://docs.microsoft.com/en-us/azure/notification-hubs/notification-hubs-push-notification-overview) iria garantir que as notificações fossem entregues em qualquer tipo de plataforma : Windows, iOS ou Android. A maior vantagem do serviço Notification Hubs é que permite abstrair os detalhes das diferentes *platform notification systems* (PNS) com uma única API e com flexibilidade nos destinatários (um ou milhões de utilizadores).

![Configuração da Notification Hub]({{ site.baseurl }}/images/edp/edp30.png)


Com esta implementação foi atingido o objectivo de detectar alterações nos padrões de consumo energético, e notificar o utilizador. 
Os cenários de aplicabilidade são vastos, e certamente haverão surpresas no EDP IoT Hackathon.

## Segurança ##

Estando em fase de preparação do Hackathon, a segurança não foi tema abordado em fase de implementação. O hackathon irá decorrer num ambiente controlado e face a EDP Boxes ligadas a pontos energéticos simulados. Tanto para avaliar a veracidade dos dados recolhidos, como para por em prática medidas de segurança a aplicar nos cenários residenciais.

Decidiu-se que a Segurança seria uma dos áreas de avaliação dos participantes. A EDP pretende verem exploradas várias técnicas para prevenir utilizações incorrectas da tecnologia. Durante o hackathon, foram também discutidas algumas medidas a poderem ser implementadas pela EDP:

- Aplicação da EDP IoT Box, protegida por selo de instalação à semelhança da EDP Box;
- Controlo dos identificadores de SIGFOX, pela EDP e associação a contas de cliente;
- Comunicação entre EDP IoT Box e Azure, garantida por código. Instalação em cliente, não necessitaria customização e/ou configuração;
- Herança de modelo de segurança de tecnologias inerentes: SIGFOX e Microsoft Azure.

## Conclusões ##

As conclusões relevantes deste projecto prendem-se comas aspectos técnicos e de negócio, com um forte impacto para a EDP.

Do ponto de vista técnico as conclusões são inerentes a *Internet of Things* (IoT). Neste cenário em particular foi possivel comprovar a utilzação de uma tecnologia *Low Power Wide Area Network* (LPWAN) como um solução viável. Tecnologias como SIGFOX ou LoRaWan devem ser contempladas quando outras redes sem fio não são adequadas - Bluetooth e BLE (e, em menor extensão, WiFi e ZigBee) geralmente não são a melhor opção para desempenho de longo alcance e as redes M2M celulares consomem muita energia e são onerosas, tanto em hardware como serviços.

Em IoT, existem várias arquitecturas para a instalação dos dispositivos. Entre os quais arquitecturas [*star*](https://en.wikipedia.org/wiki/Star_network) e [*mesh*](https://en.wikipedia.org/wiki/Mesh_networking). No cenário particular da EDP pretende-se uma solução de *near-real time*, mas as leituras energéticas poderão ser espaçadas no tempo, poupando drasticamente no consumo energético. A necessidade de conectividade à Internet não pode depender dos clientes finais, logo a opção por SIGFOX torno-se a mais adequada. 

O consumo energético, o alcance e o volume de dados são particularmente importantes na escolha da tecnologia:

| Característica | Descrição | 
|----------------------------|-----------------|
| LONGO ALCANCE | Os dispositivos podem estar até 10Km da *gateway*, dependendo da tecnologia implantada. |
| BAIXO VOLUME DE DADOS | Menos de 5.000 bits por segundo. Muitas vezes, apenas 20-256 bytes por mensagem são enviados várias vezes ao dia. |
| BAIXO CONSUMO DE ENERGIA | Isso torna a vida da bateria muito longa, podendo alcançar cinco e 10 anos. |

Para a EDP esta iniciativa é transformadora uma vez que aposta num modelo de execução totalmente diferenciador. Com a aposta em promover iniciativas relacionadas com *Internet Of Things* (IoT), a EDP aproxima-se igualmente do ecossistema de startups europeu. Desta forma conseguem inovar, descobrir talento,aumentar a rede de contactos e renovar os processos de negócio. 
Neste caso, o foco dos esforços realizados está intimamente ligado com o principal negócio da EDP - a energia e no espaço residencial.

> [*"The hackathon has become one of the latest vogue terms in business"*](http://www.mckinsey.com/business-functions/digital-mckinsey/our-insights/demystifying-the-hackathon)

> -Ferry Grijpink, principal at McKinsey, Singapore

Com os resultados do EDP IoT Hackathon, espera-se um conjunto de novos cenários na permissa de monitorização remota, *real-time* e integração com a EDP Box. Estrategicamente, a visão da EDP passa até por uma solução final que permita empresas/startups comercializarem produtos integrados com a EDP Box. Aqui poderemos idealizar a mera necessidade de desenvolver aplicações assentes num hardware económicamente viável. Deseja-se que a comunidade, *developers* disponibilizem soluções de monitorização do consumo energético. Esta abordagem *open source* poderá ser um motor importante para a proliferação de IoT com a EDP.
No final, o resultado ajudará sempre os clientes da EDP a controlarem o seu consumo energético.  

## Oportunidades futuras ##

Este foi um projeto totalmente orientado a oportunidades futuras. Este modelo de preparação para um IoT Hackathon publico organizado pela maior empresa energética do país promove um conjunto de benefícios que consideramos prometedores:

- Analisar os resultados das startups participantes numa prespectiva de negócio e técnico, tendo em conta os objetivos claros da EDP como empresa no sector energético domiliário.
- Colaborar na implementação dos melhores cenários, em conjunto com a EDP, caminhando para produtos comercializados orientados ao consumo (clientes da EDP).
- Descobrir, através do Hackathon, novas formas de recolha de leituras energéticas com base no contador inteligente da EDP. É um objectivo claro desafiar as startups a investir nas compoentens de hardware e software *cloud-based*. 
- Promover a colaboração da EDP com startups na área de IoT. Melhorar o serviço da EDP junto dos consumidores. Permitir um consumo energético mais aproriado às necessidades de cada habitação e familias. Sendo a EDP o maior fornecedor energético em Portugal o impacto tem potencial para transformar o país. 

## Resultados do EDP IoT Hackathon ##

Para finalizar este testemunho, fará todo o sentido acrescentar os principais resultados do [*EDP IoT Hackathon*](http://edpiothackathon.edp.pt/). Este evento irá decorrer entre os dias **8 Fevereiro** e **24 Fevereiro, 2017**, pelo que será feito um update deste artigo.

![Labelec & Hackfest team]({{ site.baseurl }}/images/edp/edp19.jpg)

